version: '3'
services:
  nginx:
    image: nginx
    ports:
      - "80:80"  # 将宿主机的 80 端口映射到容器的 80 端口
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf  # 挂载 Nginx 配置文件
    depends_on:
      - daily-app  # 依赖于 daily-app 服务

  daily-app:
    build:
      context: .
      dockerfile: dockerfile
    deploy:
      resources:
        limits:
          cpus: '0.50'  # 限制使用 50% 的 CPU
          memory: 512M  # 限制使用 512MB 内存
    ports:
      - "3000:3000"  # 将容器内的 3000 端口映射到主机的 3000 端口
    environment:
      - NODE_ENV=production  # 设置环境变量
      - UPLOAD_DIR=/app/uploads  # 设置上传目录路径（容器内路径）
    restart: always  # 容器退出时自动重启
    volumes:
      - ../config.env:/app/config.env  # 将宿主机上的 config.env 挂载到容器内的 /app/config.env
      - /data/uploads:/app/uploads  # 将宿主机上的上传文件目录挂载到容器内的 /app/uploads
    dns:
      - 8.8.8.8       # Google DNS
      - 114.114.114.114 # 国内DNS
    dns_search: .
    depends_on:
      - mysql  # 添加对 MySQL 的依赖
  
  mysql:
    image: mysql:8.0
    container_name: next_pro  # 保持与你原来命令相同的容器名
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: next_pro_alice
      # 可选：添加更多环境变量
      # MYSQL_DATABASE: your_database_name
      # MYSQL_USER: your_username
      # MYSQL_PASSWORD: your_password
    ports:
      - "3306:3306"  # MySQL 默认端口
    volumes:
      - /data/mysql:/var/lib/mysql  
    # 可选：添加 MySQL 配置
    command: 
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --default-authentication-plugin=mysql_native_password
    networks:
      - default  # 使用默认网络，所有服务都可以相互访问